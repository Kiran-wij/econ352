---
title: "Markdown"
output: pdf_document
date: "2022-09-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r libraries, include=FALSE}
library(tidyverse)
```


```{r data-kiran, include=FALSE}
top_rates <- read_csv("~/Econ 352/HW2/toprates_77_18.csv")
tax_rate_merged <- read_csv("~/Econ 352/HW2/tax_rate_merged.csv")
forbes400 <- read_csv("~/Econ 352/HW2/forbes400.csv")
```

```{r data-thom, include=FALSE}
top_rates <- read_csv("~/HW2/toprates_77_18.csv")
tax_rate_merged <- read_csv("~/HW2/tax_rate_merged.csv")
forbes400 <- read_csv("~/HW2/forbes400.csv")
```

*Question 1*

The goal of this exercise is to estimate the mobility of high income US taxpayers across
US states due to variation in state income top tax rates across states and over time. High income US
taxpayers are defined as tax filers reporting Adjusted Gross Income (AGI) above $1m amongst all the
other millionaires in a given year (add up all the millionaires in all the states + DC in a given year and
compute the share in each state in a given year).

1. The file toprates 77 18.csv documents the top state and federal income tax rate each year from
1977-2018. Plot the the mean and median top state and federal tax rate across states is over the
time-period 1977-2018. Are top rates trending upward or downward?

```{r question1-1}
means_and_medians <- top_rates %>% 
  group_by(year) %>% 
  summarize(mean_federal=mean(topfederalrate),
            mean_state=mean(topstaterate),
            median_federal=median(topfederalrate),
            median_state=median(topstaterate))

#Might have to filter out FEDERAL rows when calculating state means and medians...

means_and_medians

ggplot(data = means_and_medians) + geom_point(aes(x = year, y = mean_federal)) +
 geom_smooth(aes(x = year, y = mean_federal), method = "lm", se = F)

ggplot(data = means_and_medians) + geom_point(aes(x = year, y = median_federal)) +
 geom_smooth(aes(x = year, y = median_federal), method = "lm", se = F)

ggplot(data = means_and_medians) + geom_point(aes(x = year, y = mean_state)) +
 geom_smooth(aes(x = year, y = mean_state), method = "lm", se = F)

ggplot(data = means_and_medians) + geom_point(aes(x = year, y = median_state)) +
 geom_smooth(aes(x = year, y = median_state), method = "lm", se = F)

```



```{r 1-2}
group_t <- top_rates %>%
  filter(year == 2016) %>%
  filter(state_full != "FEDERAL") %>%
  arrange(topstaterate) %>%
  slice(unique(c(n() - 0:9)) ) %>%
  select(state_full, topstaterate)

group_c <- top_rates %>%
  filter(year == 2016) %>%
  filter(state_full != "FEDERAL") %>%
  arrange(topstaterate) %>%
  slice(unique(c(1:10)) ) %>%
  select(state_full, topstaterate)

group_t
group_c
```


```{r 1-3}
tax_rate_merged %>%
  filter(state_full %in% group_t$state_full & year == 2016) %>%
  summarize(mean(millionaire_share))

tax_rate_merged %>%
  filter(state_full %in% group_c$state_full & year == 2016) %>%
  summarize(mean(millionaire_share))
```


```{r 1-4}
changes_temp <- tax_rate_merged %>%
  filter(year == 2001 | year == 2016) %>%
  select(state_full, topstaterate, year) %>%
  group_by(state_full) %>%
  pivot_wider(id_cols = state_full, names_from = year, 
              values_from = c(topstaterate)) %>%
  rename("rate_2001" = 2) %>%
  rename("rate_2016" = 3) %>%
  mutate(diff = rate_2016 - rate_2001) %>%
  mutate(diff_pct = (rate_2016 - rate_2001)/rate_2001 * 100) %>%
  replace(is.na(.), 0)

group_tt <- changes_temp %>%
  arrange(desc(diff))  %>%
  head(10)

group_cc <- changes_temp %>%
  arrange(diff)  %>%
  head(10)

group_tt 
group_cc

mean(group_tt$diff)
mean(group_tt$diff_pct)

mean(group_cc$diff)
mean(group_cc$diff_pct)
  
```

compare the changes in the fraction of high income earners in states in group TT and states in group CC from 2001 to 2016 in absolute terms and in percentage terms for both groups. Fraction high earners is again defined as the ratio of tax returns with AGI above $1m to all tax returns amongst all the other millionaires in a given year. The relevant variable is called ”millionaire share”. Describe what you find? Are you surprised? 

```{r 1-5}
tax_rate_merged %>%
  filter(state_full %in% group_tt$state_full) %>%
  filter(year == 2001 | year == 2016) %>%
  group_by(year) %>%
  select(state_full, year, millionaire_share) %>%
  pivot_wider(id_cols = state_full, names_from = year, 
              values_from = c(millionaire_share)) %>%
  rename("mshare_2001" = 2) %>%
  rename("mshare_2016" = 3) %>%
  mutate(diff = mshare_2016 - mshare_2001) %>%
  mutate(diff_pct = (mshare_2016 - mshare_2001)/mshare_2001 * 100)
  
```


*Question 2*

The dataset forbes400.csv gives the list of the wealth of individuals in Forbes 400 in 2017.

1. Plot the number of individuals above a certain networth n as a function of networth n in a log-log
scale. That is, plot log(Number of Individuals Above n) as a function of log(n).

```{r question2-1}
question_2_1 <- forbes400 %>%
  mutate(num_richer = 401 - row_number(),
         log_num_richer = log(num_richer),
         log_networth = log(networth))

ggplot(question_2_1, aes(x=log_networth, y=log_num_richer)) +
  geom_point() +
  geom_smooth(aes(x = log_networth, y = log_num_richer), method = "lm", se = F)


```

2. As we discussed in class, the fact that this plot has linear slope in log-log space means that the wealth
distribution is Pareto, and that the slope of the plot equals −ζ, where ζ is the power law exponent
of the distribution. Based on your plot, what is the power law exponent of the wealth distribution
in 2017?

```{r question 2-2}

lm(log_num_richer~log_networth, data=question_2_1)

```
Based on our plot, the power law exponent  of the wealth distribution in 2017 is 1.335.

3. What does it’s magnitude imply for the magnitude of wealth inequality in the U.S. (hint: look at
the lecture notes for Lecture 9)
